"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,o=!1,a=void 0;try{for(var s,i=e[Symbol.iterator]();!(n=(s=i.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw a}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(i)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,o,a,s){try{var i=e[a](s),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,o)}function _asyncToGenerator(i){return function(){var e=this,s=arguments;return new Promise(function(t,r){var n=i.apply(e,s);function o(e){asyncGeneratorStep(n,t,r,o,a,"next",e)}function a(e){asyncGeneratorStep(n,t,r,o,a,"throw",e)}o(void 0)})}}var autocomplete,metropolygon,firstStepForm,nextDate,autocompleteEl=document.getElementById("input-address");function initGoogleMaps(){return _initGoogleMaps.apply(this,arguments)}function _initGoogleMaps(){return(_initGoogleMaps=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,getUserAddress();case 2:return address=e.sent,addressName=address.address,addressLat=parseFloat(address.address_lat),addressLng=parseFloat(address.address_lng),valid=!0,addressCoordinates=new google.maps.LatLng({lat:addressLat,lng:addressLng}),geocoder=new google.maps.Geocoder,map=new google.maps.Map(document.getElementById("map"),{center:addressCoordinates,zoom:14,disableDefaultUI:!0,fullscreenControl:!0}),marker=new google.maps.Marker({position:addressCoordinates,map:map,draggable:!0,icon:{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0",fillColor:"#CC1761",fillOpacity:1,strokeColor:"#CC1761",strokeWeight:3,scale:1.5}}),e.next=13,getMetropolygon();case 13:metropolygon=e.sent,autocomplete=new google.maps.places.Autocomplete(autocompleteEl,{bounds:getPolygonBounds(metropolygon),strictBounds:!0,componentRestrictions:{country:"fr"},fields:["address_components","formatted_address","geometry"],types:["address"]}),metropolygon.setMap(map),autocompleteEl.value=addressName,autocompleteEl.onchange=function(){document.getElementsByClassName("pac-container")[0].matches(":hover")||(autocompleteEl.focus(),autocompleteEl.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13})))},marker.addListener("dragend",function(){removeError(autocompleteEl),position={lat:marker.getPosition().lat(),lng:marker.getPosition().lng()},geocoder.geocode({location:position},function(e,t){autocompleteEl.value=e[0].formatted_address}),valid=!!google.maps.geometry.poly.containsLocation(marker.getPosition(),metropolygon)||(displayError(autocompleteEl,"Veuillez sélectionner une adresse dépendante de Bordeaux Métropole."),addressName=results[0].formatted_address,addressLat=results[0].geometry.location.lat(),addressLng=results[0].geometry.location.lng(),!1)}),autocomplete.addListener("place_changed",function(){var e;valid=!!validatePlace()&&(e=autocomplete.getPlace(),console.log(e),marker.setPosition(e.geometry.location),addressName=e.formatted_address,addressLat=e.geometry.location.lat(),addressLng=e.geometry.location.lng(),!0)});case 20:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getMetropolygon(){return _getMetropolygon.apply(this,arguments)}function _getMetropolygon(){return(_getMetropolygon=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("assets/json/metropolygon.json");case 2:return t=e.sent,e.next=5,t.json();case 5:return r=e.sent,e.abrupt("return",new google.maps.Polygon({paths:r,strokeColor:"#86A332",strokeOpacity:1,strokeWeight:3,fillColor:"#86A332",fillOpacity:0}));case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getPolygonBounds(e){var t=new google.maps.LatLngBounds;return e.getPath().forEach(function(e){return t.extend(e)}),t}function getUserAddress(){return _getUserAddress.apply(this,arguments)}function _getUserAddress(){return(_getUserAddress=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("php/tasks/address-task.php");case 2:return t=e.sent,e.next=5,t.json();case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function validatePlace(){var e=autocomplete.getPlace();if(void 0===e||!e.address_components||"street_number"!==e.address_components[0].types[0])return displayError(autocompleteEl,"Veuillez renseigner une adresse de domicile valide."),!1;var t=new google.maps.LatLng(e.geometry.location.lat(),e.geometry.location.lng());return!!google.maps.geometry.poly.containsLocation(t,metropolygon)||(displayError(autocompleteEl,"Veuillez sélectionner une adresse dépendante de Bordeaux Métropole."),!1)}function getFormDataObject(e){var t,r={},n=_createForOfIteratorHelper(e);try{for(n.s();!(t=n.n()).done;){var o=_slicedToArray(t.value,2),a=o[0],s=o[1];r[a]=s}}catch(e){n.e(e)}finally{n.f()}return r}"encombrant"===task&&(nextDate=function(){var e=new Date;for(e.setDate(e.getDate()+2);0===e.getDay()||6===e.getDay();)e.setDate(e.getDate()+1);return e},flatpickr("#input-date",{locale:"fr",altInput:!0,inline:!0,minDate:(new Date).fp_incr(2),defaultDate:nextDate(),disable:[function(e){return 0===e.getDay()||6===e.getDay()}],altFormat:"j F Y",monthSelectorType:"static"}),flatpickr("#input-time",{locale:"fr",altInput:!0,inline:!0,enableTime:!0,noCalendar:!0,time_24hr:!0,minTime:"8:00",maxTime:"16:00",defaultDate:"8:00",altFormat:"H\\hi",minuteIncrement:30}),document.getElementsByClassName("flatpickr-time-separator")[0].textContent="h"),window.onsubmit=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.preventDefault(),!t.target.classList.contains("first-step")){e.next=7;break}document.getElementsByTagName("form")[0].style.display="none",document.getElementsByTagName("form")[1].style.display="block",firstStepForm=new FormData(t.target),e.next=27;break;case 7:if(!t.target.classList.contains("second-step")){e.next=27;break}if("encombrant"!==task){e.next=13;break}firstStepForm.append("input-date",document.getElementById("input-date").value),firstStepForm.append("input-time",document.getElementById("input-time").value),e.next=19;break;case 13:if("depot"!==task){e.next=19;break}if(valid){e.next=16;break}return e.abrupt("return");case 16:firstStepForm.append("input-address",addressName),firstStepForm.append("input-lat",addressLat),firstStepForm.append("input-lng",addressLng);case 19:return console.log(getFormDataObject(firstStepForm)),e.next=22,fetch("php/tasks/report-task.php?task=".concat(task),{method:"POST",body:firstStepForm});case 22:return r=e.sent,e.next=25,r.text();case 25:r=e.sent,console.log(r);case 27:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),document.getElementById("return-button").onclick=function(){document.getElementsByTagName("form")[1].style.display="none",document.getElementsByTagName("form")[0].style.display="block"};