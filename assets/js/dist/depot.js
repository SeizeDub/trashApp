"use strict";function asyncGeneratorStep(e,t,o,r,n,a,s){try{var l=e[a](s),d=l.value}catch(e){return void o(e)}l.done?t(d):Promise.resolve(d).then(r,n)}function _asyncToGenerator(l){return function(){var e=this,s=arguments;return new Promise(function(t,o){var r=l.apply(e,s);function n(e){asyncGeneratorStep(r,t,o,n,a,"next",e)}function a(e){asyncGeneratorStep(r,t,o,n,a,"throw",e)}n(void 0)})}}var autocomplete,metropolygon,formData,autocompleteEl=document.getElementById("input-address"),userAddress={};function initGoogleMaps(){return _initGoogleMaps.apply(this,arguments)}function _initGoogleMaps(){return(_initGoogleMaps=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,getUserAddress();case 2:return dataAddress=e.sent,userAddress.name=dataAddress.address,userAddress.lat=parseFloat(dataAddress.address_lat),userAddress.lng=parseFloat(dataAddress.address_lng),valid=!0,userAddress.coordinates=new google.maps.LatLng({lat:userAddress.lat,lng:userAddress.lng}),geocoder=new google.maps.Geocoder,map=new google.maps.Map(document.getElementById("map"),{center:userAddress.coordinates,zoom:14,disableDefaultUI:!0,fullscreenControl:!0}),marker=new google.maps.Marker({position:userAddress.coordinates,map:map,draggable:!0,icon:{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0",fillColor:"#CC1761",fillOpacity:1,strokeColor:"#CC1761",strokeWeight:3,scale:1.5}}),e.next=13,getMetropolygon();case 13:metropolygon=e.sent,autocomplete=new google.maps.places.Autocomplete(autocompleteEl,{bounds:getPolygonBounds(metropolygon),strictBounds:!0,componentRestrictions:{country:"fr"},fields:["address_components","formatted_address","geometry"],types:["address"]}),navigator.geolocation&&((t=document.createElement("div")).id="geolocation",map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(t),t.onclick=function(){navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};marker.setPosition(t),removeError(autocompleteEl),geocoder.geocode({location:t},function(e){var t=e[0];if(autocompleteEl.value=t.formatted_address,!google.maps.geometry.poly.containsLocation(marker.getPosition(),metropolygon))return displayError(autocompleteEl,"Veuillez sélectionner une adresse dépendante de Bordeaux Métropole."),void(valid=!1);userAddress.name=t.formatted_address,userAddress.lat=t.geometry.location.lat(),userAddress.lng=t.geometry.location.lng(),valid=!0})})}),metropolygon.setMap(map),autocompleteEl.value=userAddress.name,autocompleteEl.onchange=function(){document.getElementsByClassName("pac-container")[0].matches(":hover")||(autocompleteEl.focus(),autocompleteEl.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13})))},marker.addListener("dragend",function(){removeError(autocompleteEl),position={lat:marker.getPosition().lat(),lng:marker.getPosition().lng()},geocoder.geocode({location:position},function(e){var t=e[0];if(autocompleteEl.value=t.formatted_address,!google.maps.geometry.poly.containsLocation(marker.getPosition(),metropolygon))return displayError(autocompleteEl,"Veuillez sélectionner une adresse dépendante de Bordeaux Métropole."),void(valid=!1);userAddress.name=t.formatted_address,userAddress.lat=t.geometry.location.lat(),userAddress.lng=t.geometry.location.lng(),valid=!0})}),autocomplete.addListener("place_changed",function(){var e;valid=!!validatePlace()&&(e=autocomplete.getPlace(),marker.setPosition(e.geometry.location),userAddress.name=e.formatted_address,userAddress.lat=e.geometry.location.lat(),userAddress.lng=e.geometry.location.lng(),!0)});case 21:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getMetropolygon(){return _getMetropolygon.apply(this,arguments)}function _getMetropolygon(){return(_getMetropolygon=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("assets/json/metropolygon.json");case 2:return t=e.sent,e.next=5,t.json();case 5:return o=e.sent,e.abrupt("return",new google.maps.Polygon({paths:o,strokeColor:"#86A332",strokeOpacity:1,strokeWeight:3,fillColor:"#86A332",fillOpacity:0}));case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function getPolygonBounds(e){var t=new google.maps.LatLngBounds;return e.getPath().forEach(function(e){return t.extend(e)}),t}function getUserAddress(){return _getUserAddress.apply(this,arguments)}function _getUserAddress(){return(_getUserAddress=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("php/tasks/address-task.php");case 2:return t=e.sent,e.next=5,t.json();case 5:return o=e.sent,e.abrupt("return",o);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function validatePlace(){var e=autocomplete.getPlace();if(void 0===e||!e.address_components||"street_number"!==e.address_components[0].types[0])return displayError(autocompleteEl,"Veuillez renseigner une adresse de domicile valide."),!1;var t=new google.maps.LatLng(e.geometry.location.lat(),e.geometry.location.lng());return!!google.maps.geometry.poly.containsLocation(t,metropolygon)||(displayError(autocompleteEl,"Veuillez sélectionner une adresse dépendante de Bordeaux Métropole."),!1)}function displayStep(e){"first"===e?(document.getElementsByTagName("form")[1].style.display="none",document.getElementsByTagName("form")[0].style.display="block",document.getElementById("return-button").style.display="none"):"second"===e&&(document.getElementsByTagName("form")[0].style.display="none",document.getElementsByTagName("form")[1].style.display="block",document.getElementById("return-button").style.display="block")}window.onsubmit=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.preventDefault(),!t.target.classList.contains("first-step")){e.next=6;break}displayStep("second"),formData=new FormData(t.target),e.next=29;break;case 6:if(!t.target.classList.contains("second-step")){e.next=29;break}if(valid){e.next=9;break}return e.abrupt("return");case 9:return formData.append("input-address",userAddress.name),formData.append("input-lat",userAddress.lat),formData.append("input-lng",userAddress.lng),e.next=14,fetch("php/tasks/depot-task.php",{method:"POST",body:formData});case 14:return o=e.sent,e.next=17,o.text();case 17:o=e.sent,e.t0=o,e.next="success"===e.t0?21:"error"===e.t0?23:"file"===e.t0?25:"missing"===e.t0?27:29;break;case 21:return document.location.replace("index.php"),e.abrupt("break",29);case 23:return displayError(document.getElementById("depot-submit"),"Une erreur est survenue."),e.abrupt("break",29);case 25:return displayError(document.getElementById("depot-submit"),"Erreur lors de l'upload de l'image."),e.abrupt("break",29);case 27:return displayError(document.getElementById("depot-submit"),"Un champ est manquant."),e.abrupt("break",29);case 29:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),document.getElementById("return-button").onclick=function(){displayStep("first")};